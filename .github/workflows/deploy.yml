name: Deploy to EC2

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # 0. Clean install and .ENV file setup
      - run: npm ci
      - run: |
          touch .env
          echo "DATABASE=${{ secrets.DATABASE }}" >> .env
          echo "OPEN_AI_API=${{ secrets.OPEN_AI_API }}" >> .env

      # 1. Install Backend Dependencies
      - name: Install Backend Dependencies
        run: |
          npm install  # Backend in root, no need to cd
        env: 
          DATABASE: DATABASE
          OPEN_AI_API: OPEN_AI_API

      # 2. Deploy Pre-Built Frontend
      - name: Deploy Pre-Built Frontend
        run: |
          sudo rm -rf /var/www/html/*
          sudo cp -r client/build/* /var/www/html/

      # 3. Deploy Backend with PM2
      - name: Deploy Backend with PM2
        run: |
          pm2 stop all || true  # Manage backend app from root
          pm2 start index.js --name api
          pm2 restart api
